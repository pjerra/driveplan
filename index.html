<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Motorsykkelrute Planlegger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            position: relative;
        }
        
        /* Desktop Layout */
        @media (min-width: 769px) {
            body {
                flex-direction: row;
            }
        }
        
        /* Mobile/Tablet Layout */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
        }
        
        .sidebar {
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        /* Desktop Sidebar */
        @media (min-width: 769px) {
            .sidebar {
                width: 420px;
                max-width: 420px;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                position: relative;
            }
        }
        
        /* Mobile Sidebar - Drawer style */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 85%;
                max-width: 350px;
                box-shadow: 2px 0 20px rgba(0,0,0,0.3);
                transform: translateX(-100%);
                display: flex;
                flex-direction: column;
                height: 100%;
                height: 100dvh;
                max-height: -webkit-fill-available;
            }

            .sidebar.open {
                transform: translateX(0);
            }
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        @media (max-width: 768px) {
            .sidebar-overlay.active {
                display: block;
            }
        }
        
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 998;
            background: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }
        }
        
        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .sidebar-header {
                padding: 15px;
            }
            
            .sidebar-header h1 {
                font-size: 18px;
            }
            
            .sidebar-header p {
                font-size: 12px;
            }
        }
        
        .sidebar-header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .close-sidebar-btn {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        @media (max-width: 768px) {
            .close-sidebar-btn {
                display: flex;
            }
        }
        
        .edit-mode-banner {
            background: #ffc107;
            color: #000;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            display: none;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .edit-mode-banner.active {
            display: block;
        }
        
        .sidebar-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        @media (min-width: 769px) {
            .sidebar-content {
                padding: 20px;
            }
        }
        
        #map {
            flex: 1;
            width: 100%;
            height: 100%;
        }
        
        @media (max-width: 768px) {
            #map {
                height: 100vh;
                width: 100vw;
            }
        }
        
        .file-upload {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }
        
        .file-label {
            display: block;
            padding: 14px 20px;
            background: #667eea;
            color: white;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            .file-label {
                padding: 16px 20px;
                font-size: 16px;
            }
        }
        
        .file-label:active {
            transform: scale(0.98);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .route-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            .route-card {
                padding: 14px;
                margin-bottom: 12px;
            }
        }
        
        .route-card:active {
            transform: scale(0.98);
        }
        
        .route-card.active {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .route-card.inactive {
            border-color: #dc3545;
            background: #fff5f5;
        }
        
        .route-card.has-detours {
            border-left: 5px solid #ffc107;
        }
        
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .route-number {
            background: #667eea;
            color: white;
            min-width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .route-number {
                min-width: 36px;
                height: 36px;
                font-size: 15px;
            }
        }
        
        .route-name {
            flex: 1;
            margin-left: 12px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .route-toggle {
            width: 54px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
            flex-shrink: 0;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            .route-toggle {
                width: 58px;
                height: 32px;
            }
        }
        
        .route-toggle.active {
            background: #28a745;
        }
        
        .route-toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: all 0.3s;
        }
        
        @media (max-width: 768px) {
            .route-toggle::after {
                width: 26px;
                height: 26px;
            }
        }
        
        .route-toggle.active::after {
            left: 27px;
        }
        
        @media (max-width: 768px) {
            .route-toggle.active::after {
                left: 29px;
            }
        }
        
        .detour-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }
        
        .detour-item {
            background: #fff9e6;
            border-left: 3px solid #ffc107;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .detour-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .detour-coords {
            color: #6c757d;
            font-size: 11px;
        }
        
        .detour-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            .detour-delete {
                padding: 8px 14px;
                font-size: 13px;
            }
        }
        
        .detour-delete:active {
            transform: scale(0.95);
        }
        
        .info-box, .warning-box, .success-box {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .controls {
            background: white;
            padding: 15px;
            border-top: 2px solid #e9ecef;
            flex-shrink: 0;
        }

        @media (min-width: 769px) {
            .controls {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .controls {
                padding: 12px;
                padding-bottom: calc(32px + env(safe-area-inset-bottom, 0px));
            }
        }
        
        button {
            width: 100%;
            padding: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            button {
                padding: 18px;
                font-size: 17px;
            }
        }
        
        button:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        button.edit-mode {
            background: #ffc107;
            color: #000;
        }
        
        button.edit-mode.active {
            background: #ff9800;
        }
        
        button.secondary {
            background: #28a745;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .stats-label {
            color: #6c757d;
        }
        
        .stats-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .progress {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 13px;
        }
        
        .legend {
            position: absolute;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 400;
            font-size: 12px;
        }
        
        @media (min-width: 769px) {
            .legend {
                bottom: 20px;
                right: 20px;
                padding: 15px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 768px) {
            .legend {
                bottom: auto;
                top: 15px;
                right: 10px;
                max-width: calc(100% - 80px);
                font-size: 11px;
                padding: 8px 10px;
            }
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .legend-color {
            width: 20px;
            height: 4px;
            margin-right: 8px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        
        .alt-routes-modal {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        
        @media (min-width: 769px) {
            .alt-routes-modal {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 500px;
                padding: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .alt-routes-modal {
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 12px 12px 0 0;
                padding: 20px;
                max-height: 70vh;
            }
        }
        
        .alt-routes-modal.active {
            display: block;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        
        .modal-overlay.active {
            display: block;
        }
        
        .alt-route-option {
            padding: 14px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
        }
        
        @media (max-width: 768px) {
            .alt-route-option {
                padding: 16px;
            }
        }
        
        .alt-route-option:active {
            transform: scale(0.98);
        }
        
        .alt-route-option.selected {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        /* Bedre touch targets for mobile */
        @media (max-width: 768px) {
            .leaflet-marker-icon {
                cursor: pointer !important;
            }
            
            /* St√∏rre kontrollknapper p√• kartet */
            .leaflet-control-zoom a {
                width: 40px !important;
                height: 40px !important;
                line-height: 40px !important;
                font-size: 24px !important;
            }
            
            .leaflet-touch .leaflet-bar {
                border: 2px solid rgba(0,0,0,0.2);
            }
        }
        
        /* Fjern zoom p√• double-tap */
        @media (max-width: 768px) {
            * {
                touch-action: pan-y pan-x;
            }

            button, .route-toggle, .file-label {
                touch-action: manipulation;
            }
        }

        /* Ny rute-knapp */
        .new-route-btn {
            display: block;
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 600;
            border: none;
            margin-top: 10px;
            touch-action: manipulation;
        }
        .new-route-btn:active { transform: scale(0.98); }

        /* Ruteoppretting-panel */
        .route-creation-panel {
            display: none;
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .route-creation-panel.active { display: block; }
        .route-creation-panel h3 { margin-bottom: 12px; font-size: 16px; color: #2c3e50; }

        .mode-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }
        .mode-tab {
            flex: 1;
            padding: 10px 6px;
            background: #e9ecef;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        .mode-tab.active {
            background: white;
            border-color: #28a745;
            color: #28a745;
        }
        .mode-tab:active { transform: scale(0.96); }

        .route-name-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
            font-family: inherit;
        }
        .route-name-input:focus { outline: none; border-color: #28a745; }

        .creation-instructions {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 10px;
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.5;
            border-radius: 0 4px 4px 0;
        }

        .creation-actions {
            display: flex;
            gap: 8px;
        }
        .creation-actions button {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            margin-bottom: 0;
        }
        .creation-actions .cancel-btn {
            background: #6c757d;
        }

        .creation-stats {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        /* Gjenopprettet-melding */
        .restored-banner {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 0 4px 4px 0;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .restored-banner button {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin-bottom: 0;
            background: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Mobile menu button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()" aria-label="Meny">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeAltRoutesModal()"></div>
    <div class="alt-routes-modal" id="altRoutesModal">
        <h3 style="margin-bottom:15px;">Velg vei</h3>
        <div id="altRoutesList"></div>
        <button onclick="closeAltRoutesModal()" style="margin-top:15px;">Lukk</button>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="close-sidebar-btn" onclick="closeSidebar()" aria-label="Lukk">√ó</button>
            <h1>üèçÔ∏è Motorsykkelrute Planlegger</h1>
            <p>Klikk p√• ruten for √• zoome ‚Ä¢ Dra punkter for √• redigere</p>
        </div>

        <div class="edit-mode-banner" id="editModeBanner">
            ‚úèÔ∏è REDIGERINGSMODUS AKTIV
            <div style="font-size:11px; margin-top:3px;">Klikk p√• kartet for √• legge til omvei</div>
        </div>
        
        <div class="sidebar-content">
            <div id="restoredBanner" class="restored-banner" style="display:none;">
                <span>‚úÖ Forrige √∏kt gjenopprettet</span>
                <button onclick="clearSavedState()">Start p√• nytt</button>
            </div>

            <div class="file-upload">
                <label for="gpxFiles" class="file-label">üìÅ Last opp GPX-filer</label>
                <input type="file" id="gpxFiles" multiple accept=".gpx">
                <div id="fileCount" style="margin-top:10px; font-size:13px; color:#6c757d; text-align:center;"></div>
                <button class="new-route-btn" onclick="openRouteCreation()">+ Ny rute</button>
            </div>

            <div id="routeCreationPanel" class="route-creation-panel">
                <h3>üõ£Ô∏è Opprett ny rute</h3>
                <input type="text" id="newRouteName" class="route-name-input" placeholder="Rutenavn (valgfritt)">
                <div class="mode-tabs">
                    <div class="mode-tab active" data-mode="click" onclick="setCreationMode('click')">üìç Klikk</div>
                    <div class="mode-tab" data-mode="startend" onclick="setCreationMode('startend')">üèÅ Start/Slutt</div>
                    <div class="mode-tab" data-mode="freehand" onclick="setCreationMode('freehand')">‚úèÔ∏è Frih√•nd</div>
                </div>
                <div id="creationInstructions" class="creation-instructions">
                    Klikk p√• kartet for √• legge til punkter. Ruten beregnes automatisk mellom hvert punkt via veier.
                </div>
                <div id="creationStats" class="creation-stats"></div>
                <div class="creation-actions">
                    <button class="cancel-btn" onclick="cancelRouteCreation()">Avbryt</button>
                    <button class="secondary" id="finishRouteBtn" onclick="finishRouteCreation()" disabled>Ferdig</button>
                </div>
            </div>

            <div class="info-box">
                üí° <strong>Slik redigerer du:</strong><br>
                ‚Ä¢ Klikk p√• rute ‚Üí zoom til rute<br>
                ‚Ä¢ Klikk p√• kart ‚Üí legg til omvei<br>
                ‚Ä¢ Dra punkter for √• justere
            </div>

            <div class="warning-box" id="editInstructions" style="display:none;">
                üìç Klikk p√• kartet der du vil kj√∏re innom.
            </div>

            <div id="routesList"></div>

            <div id="stats" class="stats">
                <div class="stats-row">
                    <span class="stats-label">Aktive ruter:</span>
                    <span class="stats-value" id="activeCount">0 / 0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Omveier:</span>
                    <span class="stats-value" id="detourCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">GPS-punkter:</span>
                    <span class="stats-value" id="totalPoints">0</span>
                </div>
            </div>

            <div id="progress" class="progress" style="display:none;">
                <div style="margin-bottom:8px; font-weight:600;" id="progressTitle">Genererer rute...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div id="progressText" style="font-size:12px; color:#6c757d; margin-top:8px;"></div>
            </div>

            <div id="generatedInfo" class="success-box" style="display:none;">
                <strong>‚úÖ Rute generert!</strong><br>
                <div id="generatedStats" style="margin-top:8px; font-size:12px;"></div>
            </div>
        </div>

        <div class="controls">
            <button id="showRoutesBtn" onclick="showRoutesOnMap()" disabled>
                üó∫Ô∏è Vis alle ruter
            </button>
            <button id="editModeBtn" class="edit-mode" onclick="toggleEditMode()" disabled>
                ‚úèÔ∏è Redigeringsmodus
            </button>
            <button id="generateBtn" class="secondary" onclick="generateRoute()" disabled>
                üöÄ Generer rute
            </button>
            <button id="downloadBtn" class="danger" onclick="downloadGPX()" disabled>
                üíæ Last ned GPX
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div class="legend">
        <div style="font-weight:600; margin-bottom:8px; font-size:12px;">Forklaring</div>
        <div class="legend-item">
            <div class="legend-color" style="background:#28a745;"></div>
            <div>Aktiv</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background:#95a5a6;"></div>
            <div>Deaktivert</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background:#3498db;"></div>
            <div>Vei</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background:#ffc107;"></div>
            <div>Omvei</div>
        </div>
    </div>

    <script>
        let map;
        let routes = [];
        let connections = [];
        let routeLayers = [];
        let connectionLayers = [];
        let detourLayers = [];
        let detourMarkers = [];
        let editMode = false;
        let isCreatingRoute = false;
        let selectedRouteForEdit = null;
        let selectedConnectionForEdit = null;
        let clickedPoint = null;
        let finalGPX = null;
        let currentAltRoutesContext = null;
        let isMobile = window.innerWidth <= 768;

        // Oppdater isMobile ved vindust√∏rrelse endring
        window.addEventListener('resize', () => {
            isMobile = window.innerWidth <= 768;
        });

        // Initialiser kart
        map = L.map('map', {
            zoomControl: true,
            touchZoom: true,
            scrollWheelZoom: true,
            doubleClickZoom: false, // Forhindre zoom p√• double-tap
            tap: !isMobile, // Disable tap on mobile for better performance
            tapTolerance: 15 // St√∏rre tolerance for mobile
        }).setView([65, 13], 5);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Flytt zoom controls p√• mobil
        if (isMobile) {
            map.zoomControl.setPosition('bottomright');
        }

        map.on('click', function(e) {
            if (isCreatingRoute) return; // Handled by creation click handler
            if (editMode && (selectedRouteForEdit !== null || selectedConnectionForEdit !== null)) {
                addDetour(e.latlng);
                if (isMobile) {
                    closeSidebar();
                }
            }
        });

        // Sidebar toggle functions
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('active');
        }

        document.getElementById('gpxFiles').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            document.getElementById('fileCount').textContent = files.length + ' filer valgt';
            
            routes = [];
            connections = [];
            for (let file of files) {
                try {
                    const route = await parseGPX(file);
                    route.active = true;
                    route.detours = [];
                    routes.push(route);
                } catch (error) {
                    console.error('Feil:', file.name, error);
                }
            }
            
            routes.sort((a, b) => a.avgLat - b.avgLat);
            displayRoutes();
            updateStats();
            document.getElementById('showRoutesBtn').disabled = false;
            document.getElementById('editModeBtn').disabled = false;
            document.getElementById('generateBtn').disabled = false;
            saveState();
        });

        async function parseGPX(file) {
            const text = await file.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');
            const trkpts = xmlDoc.getElementsByTagName('trkpt');
            const points = [];
            for (let pt of trkpts) {
                points.push([parseFloat(pt.getAttribute('lat')), parseFloat(pt.getAttribute('lon'))]);
            }
            const nameElem = xmlDoc.getElementsByTagName('name')[0] || xmlDoc.getElementsByTagName('n')[0];
            const name = nameElem ? nameElem.textContent : file.name;
            return {
                name: name,
                points: points,
                originalPoints: [...points],
                start: points[0],
                end: points[points.length - 1],
                avgLat: points.reduce((sum, p) => sum + p[0], 0) / points.length
            };
        }

        function displayRoutes() {
            const listDiv = document.getElementById('routesList');
            listDiv.innerHTML = '';
            
            routes.forEach((route, index) => {
                const card = document.createElement('div');
                const hasDetours = route.detours && route.detours.length > 0;
                card.className = 'route-card ' + (route.active ? 'active' : 'inactive') + (hasDetours ? ' has-detours' : '');
                
                card.onclick = (e) => {
                    if (e.target.classList.contains('route-toggle') || e.target.classList.contains('detour-delete')) {
                        return;
                    }
                    zoomToRoute(index);
                    if (isMobile) {
                        closeSidebar();
                    }
                };
                
                let detoursHTML = '';
                if (hasDetours) {
                    detoursHTML = '<div class="detour-list"><div style="font-size:11px; font-weight:600; margin-bottom:5px; color:#ffc107;">üîÄ Omveier:</div>';
                    route.detours.forEach((detour, dIndex) => {
                        detoursHTML += `
                            <div class="detour-item">
                                <div class="detour-header">
                                    <span style="font-weight:600;">Omvei ${dIndex + 1}</span>
                                    <button class="detour-delete" onclick="event.stopPropagation(); deleteDetour(${index}, ${dIndex})">Slett</button>
                                </div>
                                <div class="detour-coords">${detour.destination.lat.toFixed(4)}, ${detour.destination.lng.toFixed(4)}</div>
                            </div>
                        `;
                    });
                    detoursHTML += '</div>';
                }
                
                card.innerHTML = `
                    <div class="route-header">
                        <span class="route-number">${index + 1}</span>
                        <span class="route-name">${route.name}</span>
                        <div class="route-toggle ${route.active ? 'active' : ''}" onclick="event.stopPropagation(); toggleRoute(${index})"></div>
                    </div>
                    <div style="font-size:12px; color:#6c757d;">${route.points.length.toLocaleString()} punkter${hasDetours ? ' ‚Ä¢ ' + route.detours.length + ' omvei(er)' : ''}</div>
                    ${detoursHTML}
                `;
                listDiv.appendChild(card);
            });
        }

        function zoomToRoute(routeIndex) {
            const route = routes[routeIndex];
            const bounds = L.latLngBounds(route.points);
            map.fitBounds(bounds.pad(0.2));
        }

        function toggleRoute(index) {
            routes[index].active = !routes[index].active;
            displayRoutes();
            updateStats();
            showRoutesOnMap();
            saveState();
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            const banner = document.getElementById('editModeBanner');
            const instructions = document.getElementById('editInstructions');
            
            if (editMode) {
                btn.classList.add('active');
                btn.textContent = '‚úì Redigering aktiv';
                banner.classList.add('active');
                instructions.style.display = 'block';
            } else {
                btn.classList.remove('active');
                btn.textContent = '‚úèÔ∏è Redigeringsmodus';
                banner.classList.remove('active');
                instructions.style.display = 'none';
                selectedRouteForEdit = null;
                selectedConnectionForEdit = null;
                clickedPoint = null;
            }
        }

        document.getElementById('editModeBanner').addEventListener('click', toggleEditMode);

        function updateStats() {
            const activeRoutes = routes.filter(r => r.active);
            const totalPoints = activeRoutes.reduce((sum, r) => sum + r.points.length, 0);
            const totalDetours = routes.reduce((sum, r) => sum + (r.detours ? r.detours.length : 0), 0) +
                               connections.reduce((sum, c) => sum + (c.detours ? c.detours.length : 0), 0);
            
            document.getElementById('activeCount').textContent = activeRoutes.length + ' / ' + routes.length;
            document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
            document.getElementById('detourCount').textContent = totalDetours;
        }

        function showRoutesOnMap() {
            routeLayers.forEach(layer => map.removeLayer(layer));
            detourLayers.forEach(layer => map.removeLayer(layer));
            detourMarkers.forEach(marker => map.removeLayer(marker));
            routeLayers = [];
            detourLayers = [];
            detourMarkers = [];

            routes.forEach((route, routeIndex) => {
                const polyline = L.polyline(route.points, {
                    color: route.active ? '#28a745' : '#95a5a6',
                    weight: route.active ? 5 : 3,
                    opacity: route.active ? 0.7 : 0.4
                }).addTo(map);
                
                polyline.bindPopup(`<strong>${route.name}</strong><br>${route.points.length.toLocaleString()} punkter<br>${route.active ? '‚úÖ Aktiv' : '‚ùå Deaktivert'}`);
                
                if (route.active) {
                    polyline.on('click', function(e) {
                        if (editMode) {
                            L.DomEvent.stopPropagation(e);
                            selectRouteForEdit(routeIndex, e.latlng);
                        }
                    });
                }
                
                routeLayers.push(polyline);
                
                if (route.active) {
                    showDetoursForRoute(route, routeIndex);
                }
            });

            if (routeLayers.length > 0 && !map._initialZoomDone) {
                const allLayers = [...routeLayers, ...detourLayers];
                const group = L.featureGroup(allLayers);
                map.fitBounds(group.getBounds().pad(0.1));
                map._initialZoomDone = true;
            }
        }

        function showConnectionsOnMap() {
            connectionLayers.forEach(layer => map.removeLayer(layer));
            connectionLayers = [];

            connections.forEach((conn, connIndex) => {
                if (conn.routePoints) {
                    const polyline = L.polyline(conn.routePoints, {
                        color: '#3498db',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '10, 5'
                    }).addTo(map);
                    
                    polyline.bindPopup(`<strong>Vei ${connIndex + 1}</strong><br>${conn.distance.toFixed(0)} km`);
                    
                    polyline.on('click', function(e) {
                        if (editMode) {
                            L.DomEvent.stopPropagation(e);
                            selectConnectionForEdit(connIndex, e.latlng);
                        }
                    });
                    
                    connectionLayers.push(polyline);
                    showDetoursForConnection(conn, connIndex);
                }
            });
        }

        function showDetoursForRoute(route, routeIndex) {
            if (route.detours) {
                route.detours.forEach((detour, detourIndex) => {
                    showDetourMarkers(detour, routeIndex, detourIndex, 'route');
                });
            }
        }

        function showDetoursForConnection(conn, connIndex) {
            if (conn.detours) {
                conn.detours.forEach((detour, detourIndex) => {
                    showDetourMarkers(detour, connIndex, detourIndex, 'connection');
                });
            }
        }

        function showDetourMarkers(detour, parentIndex, detourIndex, type) {
            if (detour.routeToDetour && detour.routeFromDetour) {
                const lineToDetour = L.polyline(detour.routeToDetour, {
                    color: '#ffc107',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 5'
                }).addTo(map);
                detourLayers.push(lineToDetour);
                
                const lineFromDetour = L.polyline(detour.routeFromDetour, {
                    color: '#ffc107',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 5'
                }).addTo(map);
                detourLayers.push(lineFromDetour);
                
                // St√∏rre mark√∏rer p√• mobil
                const markerSize = isMobile ? 36 : 30;
                const connectionSize = isMobile ? 28 : 24;
                
                const detourMarker = L.marker([detour.destination.lat, detour.destination.lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background:#e74c3c; width:${markerSize}px; height:${markerSize}px; border-radius:50%; border:4px solid white; box-shadow:0 3px 8px rgba(0,0,0,0.4); cursor:move;"></div>`,
                        iconSize: [markerSize, markerSize],
                        iconAnchor: [markerSize/2, markerSize/2]
                    }),
                    draggable: true
                }).addTo(map);
                
                detourMarker.bindPopup('<strong>Omveipunkt</strong><br>Dra for √• flytte');
                detourMarker.on('dragend', async function(e) {
                    detour.destination = { lat: e.target.getLatLng().lat, lng: e.target.getLatLng().lng };
                    if (type === 'route') {
                        await recalculateRouteDetour(parentIndex, detourIndex);
                    } else {
                        await recalculateConnectionDetour(parentIndex, detourIndex);
                    }
                });
                detourMarkers.push(detourMarker);
                
                const startMarker = L.marker(detour.splitPoint, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background:#3498db; width:${connectionSize}px; height:${connectionSize}px; border-radius:50%; border:3px solid white; box-shadow:0 2px 6px rgba(0,0,0,0.3); cursor:move;"></div>`,
                        iconSize: [connectionSize, connectionSize],
                        iconAnchor: [connectionSize/2, connectionSize/2]
                    }),
                    draggable: true
                }).addTo(map);
                
                startMarker.bindPopup('<strong>Start-tilkobling</strong><br>Dra for √• flytte');
                startMarker.on('dragend', async function(e) {
                    const newPos = e.target.getLatLng();
                    const sourcePoints = type === 'route' ? routes[parentIndex].originalPoints : connections[parentIndex].originalPoints;
                    const nearest = findNearestPointOnRoute(sourcePoints, newPos);
                    detour.splitPoint = [nearest.lat, nearest.lng];
                    detour.splitIndex = nearest.index;
                    if (type === 'route') {
                        await recalculateRouteDetour(parentIndex, detourIndex);
                    } else {
                        await recalculateConnectionDetour(parentIndex, detourIndex);
                    }
                });
                detourMarkers.push(startMarker);
                
                const endMarker = L.marker(detour.rejoinPoint, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background:#3498db; width:${connectionSize}px; height:${connectionSize}px; border-radius:50%; border:3px solid white; box-shadow:0 2px 6px rgba(0,0,0,0.3); cursor:move;"></div>`,
                        iconSize: [connectionSize, connectionSize],
                        iconAnchor: [connectionSize/2, connectionSize/2]
                    }),
                    draggable: true
                }).addTo(map);
                
                endMarker.bindPopup('<strong>Slutt-tilkobling</strong><br>Dra for √• flytte');
                endMarker.on('dragend', async function(e) {
                    const newPos = e.target.getLatLng();
                    const sourcePoints = type === 'route' ? routes[parentIndex].originalPoints : connections[parentIndex].originalPoints;
                    const nearest = findNearestPointOnRoute(sourcePoints, newPos);
                    detour.rejoinPoint = [nearest.lat, nearest.lng];
                    detour.rejoinIndex = nearest.index;
                    if (type === 'route') {
                        await recalculateRouteDetour(parentIndex, detourIndex);
                    } else {
                        await recalculateConnectionDetour(parentIndex, detourIndex);
                    }
                });
                detourMarkers.push(endMarker);
            }
        }

        function selectRouteForEdit(routeIndex, clickLatlng) {
            selectedRouteForEdit = routeIndex;
            selectedConnectionForEdit = null;
            clickedPoint = clickLatlng;
            
            routeLayers.forEach((layer, i) => {
                const route = routes[i];
                if (i === routeIndex && route.active) {
                    layer.setStyle({ color: '#ff6b6b', weight: 7 });
                } else if (route.active) {
                    layer.setStyle({ color: '#28a745', weight: 5, opacity: 0.3 });
                }
            });
            
            const clickMarker = L.circleMarker(clickLatlng, {
                radius: isMobile ? 10 : 8,
                fillColor: '#3498db',
                color: '#fff',
                weight: 3,
                fillOpacity: 1
            }).addTo(map);
            clickMarker.bindPopup('Klikk p√• kartet der du vil kj√∏re innom').openPopup();
            detourMarkers.push(clickMarker);
        }

        function selectConnectionForEdit(connIndex, clickLatlng) {
            selectedConnectionForEdit = connIndex;
            selectedRouteForEdit = null;
            clickedPoint = clickLatlng;
            
            connectionLayers.forEach((layer, i) => {
                if (i === connIndex) {
                    layer.setStyle({ color: '#ff6b6b', weight: 6 });
                } else {
                    layer.setStyle({ color: '#3498db', weight: 4, opacity: 0.3 });
                }
            });
            
            const clickMarker = L.circleMarker(clickLatlng, {
                radius: isMobile ? 10 : 8,
                fillColor: '#3498db',
                color: '#fff',
                weight: 3,
                fillOpacity: 1
            }).addTo(map);
            clickMarker.bindPopup('Klikk p√• kartet der du vil kj√∏re innom').openPopup();
            detourMarkers.push(clickMarker);
        }

        async function addDetour(destinationLatlng) {
            if (selectedRouteForEdit !== null) {
                await addRouteDetour(destinationLatlng);
            } else if (selectedConnectionForEdit !== null) {
                await addConnectionDetour(destinationLatlng);
            }
        }

        async function addRouteDetour(destinationLatlng) {
            const route = routes[selectedRouteForEdit];
            const splitPoint = findNearestPointOnRoute(route.originalPoints, clickedPoint);
            const rejoinPoint = findPointAheadOnRoute(route.originalPoints, splitPoint, 20);
            
            document.getElementById('editInstructions').innerHTML = '‚è≥ Beregner rute...';
            
            const routeToDetour = await getRoute([splitPoint.lat, splitPoint.lng], [destinationLatlng.lat, destinationLatlng.lng]);
            const routeFromDetour = await getRoute([destinationLatlng.lat, destinationLatlng.lng], [rejoinPoint.lat, rejoinPoint.lng]);
            
            if (routeToDetour && routeFromDetour) {
                route.detours.push({
                    splitPoint: [splitPoint.lat, splitPoint.lng],
                    rejoinPoint: [rejoinPoint.lat, rejoinPoint.lng],
                    destination: { lat: destinationLatlng.lat, lng: destinationLatlng.lng },
                    routeToDetour: routeToDetour.points,
                    routeFromDetour: routeFromDetour.points,
                    splitIndex: splitPoint.index,
                    rejoinIndex: rejoinPoint.index
                });
                
                rebuildRouteWithDetours(selectedRouteForEdit);
                displayRoutes();
                updateStats();
                showRoutesOnMap();
                saveState();

                document.getElementById('editInstructions').innerHTML = '‚úì Omvei lagt til!';
            }

            resetSelection();
        }

        async function addConnectionDetour(destinationLatlng) {
            const conn = connections[selectedConnectionForEdit];
            if (!conn.detours) conn.detours = [];
            if (!conn.originalPoints) conn.originalPoints = [...conn.routePoints];

            const splitPoint = findNearestPointOnRoute(conn.originalPoints, clickedPoint);
            const rejoinPoint = findPointAheadOnRoute(conn.originalPoints, splitPoint, 20);
            
            document.getElementById('editInstructions').innerHTML = '‚è≥ Beregner omvei...';
            
            const routeToDetour = await getRoute([splitPoint.lat, splitPoint.lng], [destinationLatlng.lat, destinationLatlng.lng]);
            const routeFromDetour = await getRoute([destinationLatlng.lat, destinationLatlng.lng], [rejoinPoint.lat, rejoinPoint.lng]);
            
            if (routeToDetour && routeFromDetour) {
                conn.detours.push({
                    splitPoint: [splitPoint.lat, splitPoint.lng],
                    rejoinPoint: [rejoinPoint.lat, rejoinPoint.lng],
                    destination: { lat: destinationLatlng.lat, lng: destinationLatlng.lng },
                    routeToDetour: routeToDetour.points,
                    routeFromDetour: routeFromDetour.points,
                    splitIndex: splitPoint.index,
                    rejoinIndex: rejoinPoint.index
                });
                
                rebuildConnectionWithDetours(selectedConnectionForEdit);
                updateStats();
                showConnectionsOnMap();
                saveState();

                document.getElementById('editInstructions').innerHTML = '‚úì Omvei lagt til!';
            }

            resetSelection();
        }

        function resetSelection() {
            selectedRouteForEdit = null;
            selectedConnectionForEdit = null;
            clickedPoint = null;
            routeLayers.forEach((layer, i) => {
                const route = routes[i];
                layer.setStyle({ 
                    color: route.active ? '#28a745' : '#95a5a6', 
                    weight: route.active ? 5 : 3, 
                    opacity: route.active ? 0.7 : 0.4 
                });
            });
            connectionLayers.forEach(layer => layer.setStyle({ color: '#3498db', weight: 4, opacity: 0.7 }));
        }

        async function recalculateRouteDetour(routeIndex, detourIndex) {
            const route = routes[routeIndex];
            const detour = route.detours[detourIndex];
            
            const routeToDetour = await getRoute(detour.splitPoint, [detour.destination.lat, detour.destination.lng]);
            const routeFromDetour = await getRoute([detour.destination.lat, detour.destination.lng], detour.rejoinPoint);
            
            if (routeToDetour && routeFromDetour) {
                detour.routeToDetour = routeToDetour.points;
                detour.routeFromDetour = routeFromDetour.points;
                rebuildRouteWithDetours(routeIndex);
                displayRoutes();
                updateStats();
                showRoutesOnMap();
                saveState();
            }
        }

        async function recalculateConnectionDetour(connIndex, detourIndex) {
            const conn = connections[connIndex];
            const detour = conn.detours[detourIndex];
            
            const routeToDetour = await getRoute(detour.splitPoint, [detour.destination.lat, detour.destination.lng]);
            const routeFromDetour = await getRoute([detour.destination.lat, detour.destination.lng], detour.rejoinPoint);
            
            if (routeToDetour && routeFromDetour) {
                detour.routeToDetour = routeToDetour.points;
                detour.routeFromDetour = routeFromDetour.points;
                rebuildConnectionWithDetours(connIndex);
                updateStats();
                showConnectionsOnMap();
                saveState();
            }
        }

        function findNearestPointOnRoute(routePoints, latlng) {
            let minDist = Infinity;
            let nearestPoint = null;
            
            routePoints.forEach((point, index) => {
                const dist = Math.sqrt(Math.pow(point[0] - latlng.lat, 2) + Math.pow(point[1] - latlng.lng, 2));
                if (dist < minDist) {
                    minDist = dist;
                    nearestPoint = { lat: point[0], lng: point[1], index: index };
                }
            });
            
            return nearestPoint;
        }

        function findPointAheadOnRoute(routePoints, startPoint, stepsAhead) {
            let targetIndex = Math.min(startPoint.index + stepsAhead, routePoints.length - 1);
            const point = routePoints[targetIndex];
            return { lat: point[0], lng: point[1], index: targetIndex };
        }

        function rebuildRouteWithDetours(routeIndex) {
            const route = routes[routeIndex];
            let newPoints = [...route.originalPoints];
            const sortedDetours = [...route.detours].sort((a, b) => a.splitIndex - b.splitIndex);
            
            let offset = 0;
            sortedDetours.forEach(detour => {
                const splitIdx = detour.splitIndex + offset;
                const rejoinIdx = detour.rejoinIndex + offset;
                const removed = newPoints.splice(splitIdx, rejoinIdx - splitIdx + 1);
                const detourPoints = [...detour.routeToDetour, ...detour.routeFromDetour];
                newPoints.splice(splitIdx, 0, ...detourPoints);
                offset += detourPoints.length - removed.length;
            });
            
            route.points = newPoints;
        }

        function rebuildConnectionWithDetours(connIndex) {
            const conn = connections[connIndex];
            if (!conn.originalPoints) conn.originalPoints = [...conn.routePoints];
            
            let newPoints = [...conn.originalPoints];
            const sortedDetours = [...(conn.detours || [])].sort((a, b) => a.splitIndex - b.splitIndex);
            
            let offset = 0;
            sortedDetours.forEach(detour => {
                const splitIdx = detour.splitIndex + offset;
                const rejoinIdx = detour.rejoinIndex + offset;
                const removed = newPoints.splice(splitIdx, rejoinIdx - splitIdx + 1);
                const detourPoints = [...detour.routeToDetour, ...detour.routeFromDetour];
                newPoints.splice(splitIdx, 0, ...detourPoints);
                offset += detourPoints.length - removed.length;
            });
            
            conn.routePoints = newPoints;
        }

        function deleteDetour(routeIndex, detourIndex) {
            routes[routeIndex].detours.splice(detourIndex, 1);
            rebuildRouteWithDetours(routeIndex);
            displayRoutes();
            updateStats();
            showRoutesOnMap();
            saveState();
        }

        function compressPoints(points, maxPoints) {
            if (points.length <= maxPoints) return points;
            const compressed = [points[0]];
            const step = (points.length - 2) / (maxPoints - 2);
            for (let i = 1; i < maxPoints - 1; i++) {
                compressed.push(points[Math.floor(1 + i * step)]);
            }
            compressed.push(points[points.length - 1]);
            return compressed;
        }

        async function getRoute(start, end, alternatives = false) {
            const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&alternatives=${alternatives ? 'true' : 'false'}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    if (alternatives && data.routes.length > 1) {
                        return data.routes.map(route => ({
                            points: route.geometry.coordinates.map(c => [c[1], c[0]]),
                            distance: parseFloat((route.distance / 1000).toFixed(1)),
                            duration: Math.round(route.duration / 60)
                        }));
                    } else {
                        let routePoints = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                        const distance = (data.routes[0].distance / 1000).toFixed(1);
                        return { points: routePoints, distance: parseFloat(distance) };
                    }
                }
            } catch (error) {
                console.error('Routing error:', error);
            }
            return null;
        }

        function closeAltRoutesModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('altRoutesModal').classList.remove('active');
            currentAltRoutesContext = null;
        }

        async function generateRoute() {
            const activeRoutes = routes.filter(r => r.active);
            if (activeRoutes.length === 0) {
                alert('Ingen aktive ruter!');
                return;
            }

            const progress = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressTitle = document.getElementById('progressTitle');
            
            progress.style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generatedInfo').style.display = 'none';
            
            progressTitle.textContent = 'Genererer rute...';

            connections = [];
            for (let i = 0; i < activeRoutes.length - 1; i++) {
                progressText.textContent = `Beregner vei ${i + 1}/${activeRoutes.length - 1}`;
                const percent = Math.round(((i + 1) / (activeRoutes.length - 1)) * 100);
                progressFill.style.width = percent + '%';
                progressFill.textContent = percent + '%';

                const prev = activeRoutes[i];
                const curr = activeRoutes[i + 1];
                
                const routeData = await getRoute(prev.end, curr.start, true);
                
                if (routeData) {
                    let selectedRoute = Array.isArray(routeData) ? routeData[0] : routeData;
                    
                    connections.push({
                        from: prev,
                        to: curr,
                        routePoints: selectedRoute.points,
                        originalPoints: [...selectedRoute.points],
                        distance: selectedRoute.distance,
                        detours: [],
                        alternativeRoutes: Array.isArray(routeData) ? routeData : [routeData]
                    });
                }

                await new Promise(resolve => setTimeout(resolve, 300));
            }

            showConnectionsOnMap();

            progressTitle.textContent = 'Komprimerer...';
            
            let targetSize = 5 * 1024 * 1024;
            let compressionRatio = 1.0;
            let gpxContent;
            let fileSize;
            
            do {
                const pointsPerRoute = Math.floor((70000 / activeRoutes.length) * compressionRatio);
                
                activeRoutes.forEach(route => {
                    route.compressedPoints = compressPoints(route.points, pointsPerRoute);
                });
                
                connections.forEach(conn => {
                    conn.compressedPoints = compressPoints(conn.routePoints, Math.floor(500 * compressionRatio));
                });

                gpxContent = buildGPX(activeRoutes, connections);
                fileSize = new Blob([gpxContent]).size;
                
                if (fileSize > targetSize) {
                    compressionRatio *= 0.9;
                    progressText.textContent = `Komprimerer... ${(fileSize/1024/1024).toFixed(2)} MB`;
                }
            } while (fileSize > targetSize && compressionRatio > 0.1);

            finalGPX = gpxContent;
            
            const totalPoints = activeRoutes.reduce((sum, r) => sum + (r.compressedPoints?.length || 0), 0) +
                              connections.reduce((sum, c) => sum + (c.compressedPoints?.length || 0), 0);
            const totalDistance = connections.reduce((sum, c) => sum + c.distance, 0);
            const fileSizeMB = (fileSize / 1024 / 1024).toFixed(2);
            
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
            progressTitle.textContent = '‚úÖ Ferdig!';
            progressText.textContent = `${fileSizeMB} MB ‚Ä¢ ${totalPoints.toLocaleString()} punkter`;
            
            document.getElementById('generatedInfo').style.display = 'block';
            document.getElementById('generatedStats').innerHTML = `
                üì¶ <strong>${fileSizeMB} MB</strong> ${fileSizeMB < 5 ? '‚úÖ' : '‚ùå'}<br>
                üìç <strong>${totalPoints.toLocaleString()}</strong> punkter<br>
                üõ£Ô∏è <strong>${totalDistance.toFixed(0)} km</strong>
            `;
            
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('generateBtn').disabled = false;
            saveState();
        }

        function buildGPX(activeRoutes, connections) {
            let gpxContent = '<?xml version="1.0" encoding="UTF-8"?>\n';
            gpxContent += '<gpx version="1.1" creator="Motorcycle Route Planner" ';
            gpxContent += 'xmlns="http://www.topografix.com/GPX/1/1" ';
            gpxContent += 'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ';
            gpxContent += 'xsi:schemaLocation="http://www.topografix.com/GPX/1/1 ';
            gpxContent += 'http://www.topografix.com/GPX/1/1/gpx.xsd">\n';
            gpxContent += '  <trk>\n';
            gpxContent += '    <name>Motorsykkelrute</name>\n';
            gpxContent += `    <desc>${activeRoutes.length} turistveier med veier og omveier.</desc>\n`;

            for (let i = 0; i < activeRoutes.length; i++) {
                gpxContent += '    <trkseg>\n';

                if (i > 0 && connections[i - 1]) {
                    for (let point of connections[i - 1].compressedPoints) {
                        gpxContent += `      <trkpt lat="${point[0].toFixed(6)}" lon="${point[1].toFixed(6)}"/>\n`;
                    }
                }

                for (let point of activeRoutes[i].compressedPoints) {
                    gpxContent += `      <trkpt lat="${point[0].toFixed(6)}" lon="${point[1].toFixed(6)}"/>\n`;
                }
                gpxContent += '    </trkseg>\n';
            }

            gpxContent += '  </trk>\n';
            gpxContent += '</gpx>\n';
            return gpxContent;
        }

        function downloadGPX() {
            if (!finalGPX) return;
            const blob = new Blob([finalGPX], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'motorsykkelrute_komplett.gpx';
            a.click();
            URL.revokeObjectURL(url);
            
            if (isMobile) {
                alert('GPX-fil lastet ned! Sjekk nedlastingsmappen.');
            }
        }

        // =============================================
        // Funksjon 1: Ny rute-opprettelse
        // =============================================
        let creationMode = 'click'; // 'click', 'startend', 'freehand'
        let creationWaypoints = [];
        let creationRouteSegments = [];
        let creationMarkers = [];
        let creationPolylines = [];
        let freehandDrawing = false;
        let freehandPoints = [];
        let freehandPolyline = null;

        const modeInstructions = {
            click: 'Klikk p√• kartet for √• legge til punkter. Ruten beregnes automatisk mellom hvert punkt via veier.',
            startend: 'Klikk p√• kartet for √• sette startpunkt, deretter sluttpunkt. OSRM beregner hele ruten.',
            freehand: 'Hold museknappen nede og tegn p√• kartet. Ruten snappes til n√¶rmeste vei n√•r du slipper.'
        };

        function openRouteCreation() {
            isCreatingRoute = true;
            creationWaypoints = [];
            creationRouteSegments = [];
            cleanupCreationLayers();
            document.getElementById('routeCreationPanel').classList.add('active');
            document.getElementById('finishRouteBtn').disabled = true;
            document.getElementById('creationStats').textContent = '';
            document.getElementById('newRouteName').value = '';
            setCreationMode('click');
            if (isMobile) closeSidebar();
        }

        function setCreationMode(mode) {
            creationMode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.mode-tab[data-mode="${mode}"]`).classList.add('active');
            document.getElementById('creationInstructions').textContent = modeInstructions[mode];
            // Reset state when switching modes
            creationWaypoints = [];
            creationRouteSegments = [];
            cleanupCreationLayers();
            document.getElementById('finishRouteBtn').disabled = true;
            document.getElementById('creationStats').textContent = '';

            // Setup freehand listeners
            if (mode === 'freehand') {
                setupFreehandListeners();
            } else {
                removeFreehandListeners();
            }
        }

        function cleanupCreationLayers() {
            creationMarkers.forEach(m => map.removeLayer(m));
            creationPolylines.forEach(p => map.removeLayer(p));
            creationMarkers = [];
            creationPolylines = [];
            if (freehandPolyline) {
                map.removeLayer(freehandPolyline);
                freehandPolyline = null;
            }
            freehandPoints = [];
        }

        function cancelRouteCreation() {
            isCreatingRoute = false;
            cleanupCreationLayers();
            removeFreehandListeners();
            document.getElementById('routeCreationPanel').classList.remove('active');
        }

        // Map click handler for creation
        map.on('click', function(e) {
            if (!isCreatingRoute) return;
            if (creationMode === 'freehand') return;

            if (creationMode === 'click') {
                handleClickModeClick(e.latlng);
            } else if (creationMode === 'startend') {
                handleStartEndClick(e.latlng);
            }
        });

        async function handleClickModeClick(latlng) {
            creationWaypoints.push(latlng);
            addCreationMarker(latlng, creationWaypoints.length);

            if (creationWaypoints.length >= 2) {
                const prev = creationWaypoints[creationWaypoints.length - 2];
                const curr = creationWaypoints[creationWaypoints.length - 1];
                document.getElementById('creationInstructions').textContent = '‚è≥ Beregner vei...';
                const routeData = await getRoute([prev.lat, prev.lng], [curr.lat, curr.lng]);
                if (routeData) {
                    creationRouteSegments.push(routeData.points);
                    const polyline = L.polyline(routeData.points, {
                        color: '#28a745', weight: 5, opacity: 0.8
                    }).addTo(map);
                    creationPolylines.push(polyline);
                }
                document.getElementById('creationInstructions').textContent = modeInstructions.click;
                updateCreationStats();
                document.getElementById('finishRouteBtn').disabled = false;
            }
        }

        async function handleStartEndClick(latlng) {
            if (creationWaypoints.length >= 2) return; // Maks 2 punkter i start/slutt-modus
            creationWaypoints.push(latlng);
            addCreationMarker(latlng, creationWaypoints.length);

            if (creationWaypoints.length === 1) {
                document.getElementById('creationInstructions').textContent = 'Klikk n√• p√• sluttpunktet.';
            } else if (creationWaypoints.length === 2) {
                document.getElementById('creationInstructions').textContent = '‚è≥ Beregner rute...';
                const start = creationWaypoints[0];
                const end = creationWaypoints[1];
                const routeData = await getRoute([start.lat, start.lng], [end.lat, end.lng], true);

                if (routeData) {
                    const routeOptions = Array.isArray(routeData) ? routeData : [routeData];
                    if (routeOptions.length > 1) {
                        showCreationAltRoutes(routeOptions);
                        return; // La showCreationAltRoutes sette instruksjonsteksten
                    } else {
                        selectCreationRoute(routeOptions[0]);
                    }
                }
                document.getElementById('creationInstructions').textContent = modeInstructions.startend;
            }
        }

        function showCreationAltRoutes(routeOptions) {
            // Show alternatives on map with different colors
            const colors = ['#28a745', '#3498db', '#e74c3c'];
            routeOptions.forEach((opt, i) => {
                const poly = L.polyline(opt.points, {
                    color: colors[i % colors.length],
                    weight: i === 0 ? 6 : 4,
                    opacity: i === 0 ? 0.9 : 0.5
                }).addTo(map);
                poly.bindPopup(`Rute ${i + 1}: ${opt.distance} km, ~${opt.duration} min`);
                poly.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    creationPolylines.forEach(p => map.removeLayer(p));
                    creationPolylines = [];
                    selectCreationRoute(opt);
                });
                creationPolylines.push(poly);
            });
            document.getElementById('creationInstructions').textContent = 'Klikk p√• en av rutene p√• kartet for √• velge den.';
        }

        function selectCreationRoute(routeOption) {
            creationPolylines.forEach(p => map.removeLayer(p));
            creationPolylines = [];
            creationRouteSegments = [routeOption.points];
            const polyline = L.polyline(routeOption.points, {
                color: '#28a745', weight: 5, opacity: 0.8
            }).addTo(map);
            creationPolylines.push(polyline);
            updateCreationStats();
            document.getElementById('finishRouteBtn').disabled = false;
        }

        function addCreationMarker(latlng, number) {
            const markerSize = isMobile ? 32 : 28;
            const marker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background:#667eea; color:white; width:${markerSize}px; height:${markerSize}px; border-radius:50%; border:3px solid white; box-shadow:0 2px 6px rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:12px;">${number}</div>`,
                    iconSize: [markerSize, markerSize],
                    iconAnchor: [markerSize / 2, markerSize / 2]
                })
            }).addTo(map);
            creationMarkers.push(marker);
        }

        function updateCreationStats() {
            const allPoints = creationRouteSegments.flat();
            if (allPoints.length > 0) {
                let totalDist = 0;
                for (let i = 1; i < allPoints.length; i++) {
                    totalDist += map.distance(L.latLng(allPoints[i - 1][0], allPoints[i - 1][1]), L.latLng(allPoints[i][0], allPoints[i][1]));
                }
                document.getElementById('creationStats').textContent =
                    `${creationWaypoints.length} punkt(er) ‚Ä¢ ~${(totalDist / 1000).toFixed(1)} km ‚Ä¢ ${allPoints.length} GPS-punkter`;
            }
        }

        // Freehand drawing
        let _freehandMoveHandler = null;
        let _freehandUpHandler = null;
        let _freehandDownHandler = null;

        function setupFreehandListeners() {
            removeFreehandListeners();
            const container = map.getContainer();
            map.dragging.disable();

            _freehandDownHandler = function(e) {
                if (!isCreatingRoute || creationMode !== 'freehand') return;
                freehandDrawing = true;
                freehandPoints = [];
                const latlng = map.containerPointToLatLng(L.point(e.touches ? e.touches[0].clientX - container.getBoundingClientRect().left : e.clientX - container.getBoundingClientRect().left, e.touches ? e.touches[0].clientY - container.getBoundingClientRect().top : e.clientY - container.getBoundingClientRect().top));
                freehandPoints.push(latlng);
                if (freehandPolyline) map.removeLayer(freehandPolyline);
                freehandPolyline = L.polyline([latlng], { color: '#e74c3c', weight: 3, dashArray: '5,5' }).addTo(map);
            };

            _freehandMoveHandler = function(e) {
                if (!freehandDrawing) return;
                e.preventDefault();
                const latlng = map.containerPointToLatLng(L.point(e.touches ? e.touches[0].clientX - container.getBoundingClientRect().left : e.clientX - container.getBoundingClientRect().left, e.touches ? e.touches[0].clientY - container.getBoundingClientRect().top : e.clientY - container.getBoundingClientRect().top));
                freehandPoints.push(latlng);
                freehandPolyline.addLatLng(latlng);
            };

            _freehandUpHandler = async function() {
                if (!freehandDrawing) return;
                freehandDrawing = false;
                if (freehandPoints.length < 2) return;

                document.getElementById('creationInstructions').textContent = '‚è≥ Snapper til vei...';

                // Pick start, end, and some intermediate points
                const numWaypoints = Math.min(Math.max(Math.floor(freehandPoints.length / 10), 2), 25);
                const step = (freehandPoints.length - 1) / (numWaypoints - 1);
                const waypoints = [];
                for (let i = 0; i < numWaypoints; i++) {
                    const idx = Math.min(Math.round(i * step), freehandPoints.length - 1);
                    waypoints.push(freehandPoints[idx]);
                }

                // Route through OSRM with waypoints
                const coords = waypoints.map(w => `${w.lng},${w.lat}`).join(';');
                try {
                    const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`);
                    const data = await response.json();
                    if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                        const routePoints = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                        if (freehandPolyline) map.removeLayer(freehandPolyline);
                        freehandPolyline = null;

                        creationRouteSegments = [routePoints];
                        creationWaypoints = [waypoints[0], waypoints[waypoints.length - 1]];

                        creationPolylines.forEach(p => map.removeLayer(p));
                        creationPolylines = [];
                        const polyline = L.polyline(routePoints, {
                            color: '#28a745', weight: 5, opacity: 0.8
                        }).addTo(map);
                        creationPolylines.push(polyline);

                        // Add start/end markers
                        cleanupCreationMarkers();
                        addCreationMarker(waypoints[0], 'S');
                        addCreationMarker(waypoints[waypoints.length - 1], 'E');

                        updateCreationStats();
                        document.getElementById('finishRouteBtn').disabled = false;
                    }
                } catch (err) {
                    console.error('Freehand routing error:', err);
                }
                document.getElementById('creationInstructions').textContent = modeInstructions.freehand;
            };

            container.addEventListener('mousedown', _freehandDownHandler);
            container.addEventListener('mousemove', _freehandMoveHandler);
            container.addEventListener('mouseup', _freehandUpHandler);
            container.addEventListener('touchstart', _freehandDownHandler, { passive: false });
            container.addEventListener('touchmove', _freehandMoveHandler, { passive: false });
            container.addEventListener('touchend', _freehandUpHandler);
        }

        function removeFreehandListeners() {
            freehandDrawing = false;
            const container = map.getContainer();
            if (_freehandDownHandler) container.removeEventListener('mousedown', _freehandDownHandler);
            if (_freehandMoveHandler) container.removeEventListener('mousemove', _freehandMoveHandler);
            if (_freehandUpHandler) container.removeEventListener('mouseup', _freehandUpHandler);
            if (_freehandDownHandler) container.removeEventListener('touchstart', _freehandDownHandler);
            if (_freehandMoveHandler) container.removeEventListener('touchmove', _freehandMoveHandler);
            if (_freehandUpHandler) container.removeEventListener('touchend', _freehandUpHandler);
            _freehandDownHandler = null;
            _freehandMoveHandler = null;
            _freehandUpHandler = null;
            map.dragging.enable();
        }

        function cleanupCreationMarkers() {
            creationMarkers.forEach(m => map.removeLayer(m));
            creationMarkers = [];
        }

        function finishRouteCreation() {
            const allPoints = creationRouteSegments.flat();
            if (allPoints.length === 0) return;

            const name = document.getElementById('newRouteName').value.trim() || `Ny rute ${routes.length + 1}`;

            const newRoute = {
                name: name,
                points: allPoints,
                originalPoints: [...allPoints],
                start: allPoints[0],
                end: allPoints[allPoints.length - 1],
                avgLat: allPoints.reduce((sum, p) => sum + p[0], 0) / allPoints.length,
                active: true,
                detours: []
            };

            routes.push(newRoute);
            routes.sort((a, b) => a.avgLat - b.avgLat);

            cleanupCreationLayers();
            removeFreehandListeners();
            isCreatingRoute = false;
            document.getElementById('routeCreationPanel').classList.remove('active');

            displayRoutes();
            updateStats();
            showRoutesOnMap();

            document.getElementById('showRoutesBtn').disabled = false;
            document.getElementById('editModeBtn').disabled = false;
            document.getElementById('generateBtn').disabled = false;

            saveState();
        }

        // =============================================
        // Funksjon 2: Automatisk lagring (localStorage)
        // =============================================
        function saveState() {
            try {
                const state = {
                    routes: routes.map(r => ({
                        name: r.name,
                        points: r.points,
                        originalPoints: r.originalPoints,
                        start: r.start,
                        end: r.end,
                        avgLat: r.avgLat,
                        active: r.active,
                        detours: (r.detours || []).map(d => ({
                            splitPoint: d.splitPoint,
                            rejoinPoint: d.rejoinPoint,
                            destination: d.destination,
                            routeToDetour: d.routeToDetour,
                            routeFromDetour: d.routeFromDetour,
                            splitIndex: d.splitIndex,
                            rejoinIndex: d.rejoinIndex
                        }))
                    })),
                    connections: connections.map(c => ({
                        routePoints: c.routePoints,
                        originalPoints: c.originalPoints,
                        distance: c.distance,
                        detours: (c.detours || []).map(d => ({
                            splitPoint: d.splitPoint,
                            rejoinPoint: d.rejoinPoint,
                            destination: d.destination,
                            routeToDetour: d.routeToDetour,
                            routeFromDetour: d.routeFromDetour,
                            splitIndex: d.splitIndex,
                            rejoinIndex: d.rejoinIndex
                        })),
                        alternativeRoutes: c.alternativeRoutes
                    })),
                    mapView: {
                        center: map.getCenter(),
                        zoom: map.getZoom()
                    }
                };
                localStorage.setItem('driveplan_state', JSON.stringify(state));
            } catch (e) {
                console.warn('Kunne ikke lagre tilstand:', e);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('driveplan_state');
                if (!saved) return false;

                const state = JSON.parse(saved);
                if (!state.routes || state.routes.length === 0) return false;

                routes = state.routes.map(r => ({
                    name: r.name,
                    points: r.points,
                    originalPoints: r.originalPoints,
                    start: r.start,
                    end: r.end,
                    avgLat: r.avgLat,
                    active: r.active,
                    detours: r.detours || []
                }));

                connections = (state.connections || []).map(c => ({
                    routePoints: c.routePoints,
                    originalPoints: c.originalPoints,
                    distance: c.distance,
                    detours: c.detours || [],
                    alternativeRoutes: c.alternativeRoutes || []
                }));

                if (state.mapView) {
                    map.setView([state.mapView.center.lat, state.mapView.center.lng], state.mapView.zoom);
                    map._initialZoomDone = true; // Forhindre at showRoutesOnMap overskriver kartutsnitt
                }

                displayRoutes();
                updateStats();
                showRoutesOnMap();
                if (connections.length > 0) showConnectionsOnMap();

                document.getElementById('showRoutesBtn').disabled = false;
                document.getElementById('editModeBtn').disabled = false;
                document.getElementById('generateBtn').disabled = false;

                document.getElementById('restoredBanner').style.display = 'flex';

                return true;
            } catch (e) {
                console.warn('Kunne ikke laste tilstand:', e);
                return false;
            }
        }

        function clearSavedState() {
            localStorage.removeItem('driveplan_state');
            routes = [];
            connections = [];
            routeLayers.forEach(l => map.removeLayer(l));
            connectionLayers.forEach(l => map.removeLayer(l));
            detourLayers.forEach(l => map.removeLayer(l));
            detourMarkers.forEach(m => map.removeLayer(m));
            routeLayers = [];
            connectionLayers = [];
            detourLayers = [];
            detourMarkers = [];
            displayRoutes();
            updateStats();
            document.getElementById('restoredBanner').style.display = 'none';
            document.getElementById('showRoutesBtn').disabled = true;
            document.getElementById('editModeBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('generatedInfo').style.display = 'none';
            document.getElementById('progress').style.display = 'none';
            finalGPX = null;
            map.setView([65, 13], 5);
        }

        // Last inn lagret tilstand ved oppstart
        loadState();

        // Oppdater map st√∏rrelse n√•r orientation endres
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                map.invalidateSize();
            }, 100);
        });
    </script>
</body>
</html>